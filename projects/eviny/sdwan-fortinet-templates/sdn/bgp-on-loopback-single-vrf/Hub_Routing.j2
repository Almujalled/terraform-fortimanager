{#_____ IMPORT PROJECT TEMPLATE _____#}
{% import 'Project' as project with context %}

{#_____ BGP ROUTING _____#}
config router bgp
  set as {{ project.bgp_as }}
  set router-id {{ loopback_ip }}
  set keepalive-timer 5
  set holdtime-timer 15
  set ibgp-multipath enable
  set ebgp-multipath enable
  set recursive-next-hop enable
  config neighbor-group
    edit "SPOKE"
      set soft-reconfiguration enable
      set advertisement-interval 1
      set next-hop-self enable
      set remote-as {{ project.bgp_as }}
      set interface "loopback1"
      set update-source "loopback1"
      set route-reflector-client enable
    next
  end
  config neighbor-range
    edit 1
      set prefix {{ project.loopback_summary }}
      set neighbor-group "SPOKE"
    next
  end
  config network
    edit 1
      set prefix {{ project.loopback_summary }}
    next
    edit 2
      set prefix {{ project.lan_summary }}
    next
  end
end

{#_____ OVERLAY STICKINESS _____#}
config router policy
  edit 1
    set input-device "OLT_HS_PP"
    set output-device "OLT_HS_PP"
    set dst {{ project.lan_summary }}
  next
  edit 2
    set input-device "OLT_HS_SP"
    set output-device "OLT_HS_SP"
    set dst {{ project.lan_summary }}
  next
  edit 3
    set input-device "OLT_HS_PS"
    set output-device "OLT_HS_PS"
    set dst {{ project.lan_summary }}
  next
  edit 4
    set input-device "OLT_HS_SS"
    set output-device "OLT_HS_SS"
    set dst {{ project.lan_summary }}
  next
end

{#_____ STATIC ROUTES _____#}
config router static
  edit 101
    set dst {{ project.lan_summary }}
    set blackhole enable
    set comment "Avoid potential leak of corporate traffic to underlay"
  next
  edit 102
    set dst {{ project.loopback_summary }}
    set blackhole enable
    set comment "Avoid potential recursive resolution of corporate BGP routes via underlay"
  next
end